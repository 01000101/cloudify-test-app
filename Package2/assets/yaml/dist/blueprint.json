{
  "tosca_definitions_version": "cloudify_dsl_1_1",
  "imports": [
    "http://www.getcloudify.org/spec/cloudify/3.2.1/types.yaml",
    "https://raw.githubusercontent.com/cloudify-cosmo/cloudify-openstack-plugin/1.2.1/plugin.yaml"
  ],
  "inputs": {
    "os_external_network": {
      "description": "External network (name) in OpenStack",
      "default": "Ext-Net"
    },
    "os_internal_network": {
      "description": "Internal network (name) in OpenStack",
      "default": "Joscor-Int-Net"
    },
    "os_internal_subnet": {
      "description": "Internal network (name) in OpenStack",
      "default": "Joscor-Int-Subnet"
    },
    "os_security_group": {
      "description": "Security Group (name) in OpenStack",
      "default": "Joscor-Sec-01"
    },
    "os_host_image_id": {
      "description": "Image UUID for the host server",
      "default": "564be9dd-5a06-4a26-ba50-9453f972e483"
    },
    "ssh_tmp_priv_key_path": {
      "description": "Relative path (from blueprint) to the temporary private key to SSH between Oracle RAC servers",
      "default": "keys/temp.key"
    },
    "ssh_tmp_pub_key_path": {
      "description": "Relative path (from blueprint) to the temporary public key to allow SSH into Oracle RAC servers",
      "default": "keys/temp.key.pub"
    },
    "oracle_key_path": {
      "description": "Absolute path to where the Oracle RAC keys will be generated / retrieved (creates file + file.pub)",
      "default": "/tmp/oracle/joscor.key"
    },
    "agent_user": {
      "description": "Cloudify deployment username",
      "default": "ubuntu"
    },
    "agent_ssh_key": {
      "description": "Cloudify deployment SSH key file path",
      "default": "/root/.ssh/agent_key.pem"
    }
  },
  "node_types": {
    "joscor.nodes.FakeModule": {
      "derived_from": "cloudify.nodes.Root",
      "properties": {
        "tmp_priv_key_path": {
          "default": {
            "get_input": "ssh_tmp_priv_key_path"
          }
        },
        "oracle_key_path": {
          "default": {
            "get_input": "oracle_key_path"
          }
        }
      }
    },
    "joscor.nodes.OracleModule": {
      "derived_from": "cloudify.nodes.ApplicationModule",
      "properties": {
        "tmp_pub_key_path": {
          "default": {
            "get_input": "ssh_tmp_pub_key_path"
          }
        },
        "oracle_key_path": {
          "default": {
            "get_input": "oracle_key_path"
          }
        }
      }
    }
  },
  "node_templates": {
    "host_network": {
      "type": "cloudify.openstack.nodes.Network",
      "properties": {
        "resource_id": {
          "get_input": "os_internal_network"
        }
      }
    },
    "host_subnet": {
      "type": "cloudify.openstack.nodes.Subnet",
      "properties": {
        "resource_id": {
          "get_input": "os_internal_subnet"
        }
      },
      "interfaces": {
        "cloudify.interfaces.lifecycle": {
          "create": {
            "inputs": {
              "args": {
                "cidr": "172.16.0.0/24",
                "ip_version": 4
              }
            }
          }
        }
      },
      "relationships": [
        {
          "target": "host_network",
          "type": "cloudify.relationships.contained_in"
        }
      ]
    },
    "host_security_group": {
      "type": "cloudify.openstack.nodes.SecurityGroup",
      "properties": {
        "resource_id": {
          "get_input": "os_security_group"
        }
      }
    },
    "host_01": {
      "type": "cloudify.openstack.nodes.Server",
      "properties": {
        "resource_id": "Oracle-Host-01"
      },
      "interfaces": {
        "cloudify.interfaces.lifecycle": {
          "create": {
            "inputs": {
              "args": {
                "image": {
                  "get_input": "os_host_image_id"
                },
                "flavor": 102
              }
            }
          }
        }
      },
      "relationships": [
        {
          "target": "host_network",
          "type": "cloudify.relationships.connected_to"
        },
        {
          "target": "host_subnet",
          "type": "cloudify.relationships.depends_on"
        },
        {
          "target": "host_security_group",
          "type": "cloudify.openstack.server_connected_to_security_group"
        }
      ]
    },
    "host_02": {
      "type": "cloudify.openstack.nodes.Server",
      "properties": {
        "resource_id": "Oracle-Host-02"
      },
      "interfaces": {
        "cloudify.interfaces.lifecycle": {
          "create": {
            "inputs": {
              "args": {
                "image": {
                  "get_input": "os_host_image_id"
                },
                "flavor": 102
              }
            }
          }
        }
      },
      "relationships": [
        {
          "target": "host_network",
          "type": "cloudify.relationships.connected_to"
        },
        {
          "target": "host_subnet",
          "type": "cloudify.relationships.depends_on"
        },
        {
          "target": "host_security_group",
          "type": "cloudify.openstack.server_connected_to_security_group"
        }
      ]
    },
    "oracle_rac_01": {
      "type": "cloudify.nodes.ApplicationServer",
      "relationships": [
        {
          "type": "cloudify.relationships.contained_in",
          "target": "host_01"
        }
      ]
    },
    "oracle_rac_02": {
      "type": "cloudify.nodes.ApplicationServer",
      "relationships": [
        {
          "type": "cloudify.relationships.contained_in",
          "target": "host_02"
        }
      ]
    },
    "oracle_rac_app_01": {
      "type": "joscor.nodes.OracleModule",
      "interfaces": {
        "cloudify.interfaces.lifecycle": {
          "configure": "scripts/poc-allow-ssh.py"
        }
      },
      "relationships": [
        {
          "type": "cloudify.relationships.contained_in",
          "target": "oracle_rac_01"
        }
      ]
    },
    "oracle_rac_app_02": {
      "type": "joscor.nodes.OracleModule",
      "interfaces": {
        "cloudify.interfaces.lifecycle": {
          "configure": "scripts/poc-allow-ssh.py"
        }
      },
      "relationships": [
        {
          "type": "cloudify.relationships.contained_in",
          "target": "oracle_rac_02"
        }
      ]
    },
    "fake_module": {
      "type": "joscor.nodes.FakeModule",
      "interfaces": {
        "cloudify.interfaces.lifecycle": {
          "configure": "scripts/poc.py"
        }
      },
      "relationships": [
        {
          "type": "cloudify.relationships.contained_in",
          "target": "oracle_rac_02"
        },
        {
          "type": "cloudify.relationships.depends_on",
          "target": "oracle_rac_app_01"
        },
        {
          "type": "cloudify.relationships.depends_on",
          "target": "oracle_rac_app_02"
        }
      ]
    }
  }
}